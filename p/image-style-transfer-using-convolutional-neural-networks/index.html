<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="CVPR 2016ï¼Œå¤§ä½“åŸç†ï¼šé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚åŸæ–‡é“¾æ¥ï¼š[Image Style Transfer Using Convolutional Neural Networks](https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf)"><title>Image Style Transfer Using Convolutional Neural Networks</title><link rel=canonical href=https://davidham3.github.io/blog/p/image-style-transfer-using-convolutional-neural-networks/><link rel=stylesheet href=/blog/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Image Style Transfer Using Convolutional Neural Networks"><meta property='og:description' content="CVPR 2016ï¼Œå¤§ä½“åŸç†ï¼šé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚åŸæ–‡é“¾æ¥ï¼š[Image Style Transfer Using Convolutional Neural Networks](https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf)"><meta property='og:url' content='https://davidham3.github.io/blog/p/image-style-transfer-using-convolutional-neural-networks/'><meta property='og:site_name' content='Davidhamçš„åšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='deep learning'><meta property='article:tag' content='machine learning'><meta property='article:tag' content='computer vision'><meta property='article:tag' content='image style transfer'><meta property='article:tag' content='å·²å¤ç°'><meta property='article:published_time' content='2018-02-24T23:51:39+00:00'><meta property='article:modified_time' content='2018-02-24T23:51:39+00:00'><meta name=twitter:title content="Image Style Transfer Using Convolutional Neural Networks"><meta name=twitter:description content="CVPR 2016ï¼Œå¤§ä½“åŸç†ï¼šé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚åŸæ–‡é“¾æ¥ï¼š[Image Style Transfer Using Convolutional Neural Networks](https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf)"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu_a95981f1fc190aef.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸš€</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>Davidhamçš„åšå®¢</a></h1><h2 class=site-description>éšä¾¿å†™å†™</h2></div></header><ol class=menu-social><li><a href=https://github.com/Davidham3 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/blog/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#content-representation>content representation</a></li><li><a href=#style-representation>style representation</a></li><li><a href=#style-transfer>style transfer</a></li></ol><ol><li><a href=#trade-off-between-content-and-style-matching>Trade-off between content and style matching</a></li><li><a href=#effect-of-different-layers-of-the-convolutional-neural-network>Effect of different layers of the Convolutional Neural Network</a></li><li><a href=#initialisation-of-gradient-descent>Initialisation of gradient descent</a></li></ol><ol><li><a href=#total-variation-denoising>Total variation denoising</a><ol><li><a href=#1d-signal-series>1D signal series</a></li><li><a href=#regularization-properties>Regularization properties</a></li><li><a href=#2d-signal-images>2D signal images</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blog/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/>è®ºæ–‡é˜…è¯»ç¬”è®°</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/image-style-transfer-using-convolutional-neural-networks/>Image Style Transfer Using Convolutional Neural Networks</a></h2><h3 class=article-subtitle>CVPR 2016ï¼Œå¤§ä½“åŸç†ï¼šé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚åŸæ–‡é“¾æ¥ï¼š[Image Style Transfer Using Convolutional Neural Networks](https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf)</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 24, 2018</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 14 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>CVPR 2016ï¼Œå¤§ä½“åŸç†ï¼šé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚åŸæ–‡é“¾æ¥ï¼š<a class=link href=https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf target=_blank rel=noopener>Image Style Transfer Using Convolutional Neural Networks</a></p><h1 id=image-style-transfer-using-convolutional-neural-networks>Image Style Transfer Using Convolutional Neural Networks</h1><h1 id=å¤§ä½“åŸç†>å¤§ä½“åŸç†</h1><p>é€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºé£æ ¼å›¾ç‰‡ï¼Œä¸€å¼ ä½œä¸ºå†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ˜¯å°†é£æ ¼å›¾ç‰‡ä¸­çš„é£æ ¼ï¼Œè¿ç§»åˆ°å†…å®¹å›¾ç‰‡ä¸Šã€‚æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åœ¨ImageNetä¸Šè®­ç»ƒå¥½çš„VGG19ï¼Œå› ä¸ºè¿™ç§æ·±å±‚æ¬¡çš„å·ç§¯ç¥ç»ç½‘ç»œçš„å·ç§¯æ ¸å¯ä»¥æœ‰æ•ˆçš„æ•æ‰ä¸€äº›ç‰¹å¾ï¼Œè¶Šé è¿‘è¾“å…¥çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šä½ï¼Œè€Œè¶Šé è¿‘è¾“å‡ºçš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯å±‚æ¬¡è¶Šé«˜ï¼Œå› æ­¤å¯ä»¥ç”¨é«˜å±‚æ¬¡çš„å·ç§¯å±‚æ•æ‰åˆ°çš„ä¿¡æ¯ä½œä¸ºå¯¹é£æ ¼å›¾ç‰‡é£æ ¼çš„æ•æ‰ã€‚è€Œä½å±‚æ¬¡çš„å·ç§¯å±‚ç”¨æ¥æ•æ‰å†…å®¹å›¾ç‰‡ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥å®é™…çš„æ“ä½œå°±æ˜¯ï¼Œå°†å†…å®¹å›¾ç‰‡æ‰”åˆ°è®­ç»ƒå¥½çš„VGG19ä¸­ï¼Œå–å‡ºä½å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ï¼Œç„¶åå†æŠŠé£æ ¼å›¾ç‰‡æ”¾åˆ°VGG19ä¸­ï¼Œå–å‡ºé«˜å±‚æ¬¡çš„å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¿å­˜èµ·æ¥ã€‚ç„¶åéšæœºç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæ‰”åˆ°VGG19ä¸­ï¼Œå°†åˆšæ‰ä¿å­˜ä¸‹æ¥çš„å·ç§¯å±‚çš„è¾“å‡ºçš„é‚£äº›å·ç§¯å±‚çš„ç»“æœæ‹¿å‡ºæ¥ï¼Œå’Œé‚£äº›ä¿å­˜çš„ç»“æœåšä¸ªlossï¼Œç„¶åå¯¹è¾“å…¥çš„éšæœºç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œä¼˜åŒ–å³å¯ã€‚(Fig2)
<img src=/blog/images/image-style-transfer-using-convolutional-neural-networks/Fig2.PNG loading=lazy alt=Fig2></p><p>Figure 2. Style transfer algorithm. First content and style features are extracted and stored. The style image $\vec{a}$ is passed through the network and its style representation $A^l$ on all layers included are computed and stored(left). The content image $\vec{p}$ is passed through the network and the content representation $P^l$ in one layer is stored(right). Then a random white noise image $\vec{x}$ is passed through the network and its style features $G^l$ and content features $F^l$ are computed. On each layer included in the style representation, the element-wise mean squared difference between $G^l$ and $A^l$ is computed to give the style loss $\mathcal{L}_{style}$(left). Also the mean squared difference between $F^l$ and $P^l$ is computed to give the content loss $\mathcal{L}_{content}(right)$. The total loss $\mathcal{L}_{total}$ is then a linear combination between the content and the style loss. Its derivative with respect to the pixel values can be computed using error back-propagation(middle). This gradient is used to iteratively update the image $\vec{x}$ until it simultaneously matches the style features of the style image $\vec{a}$ and the content features of the content image $\vec{p}$(middle, bottom).</p><h1 id=deep-image-representations>Deep image representations</h1><p>We used the feature space provided by a normalized version of the 16 convolutional and 5 pooling layers of the 19-layer VGG network. We normalized the network by scaling the weights such that the mean activation of each convolutional filter over images and positions is equal to one. Such re-scaling can be done for the VGG network without changing its output, because it contains only rectifying linear activation functions and no normalization or pooling over feature maps.
å…¶å®è¿™é‡Œæˆ‘ä¸æ˜¯å¾ˆæ˜ç™½ä¸ºä»€ä¹ˆä¸ä¼šå½±å“è¾“å‡ºã€‚</p><h2 id=content-representation>content representation</h2><p>A layer with $N_l$ distinct filters has $N_l$ feature maps each of size $M_l$, where $M_l$ is the height times the width of the feature map. So the responses in a layer $l$ can be stored in a matrix $F^l \in \mathcal{R}^{N_l \times M_l}$ where $F^l_{ij}$ is the activation of the $i^{th}$ filter at position $j$ in layer $l$.
Let $\vec{p}$ and $\vec{x}$ be the original image and the image that is generated, and $P^l$ and $F^l$ their respective feature representation in layer $l$.
We then define the squared-error loss between the two feature representations</p>$$\mathcal{L}\_{content}(\vec{p}, \vec{x}, l) = \frac{1}{2}\sum\_{i, j}(F^l\_{ij}-P^l\_{ij})^2$$<p>The derivative of this loss with respect to the activations in layer $l$ equals</p><p>\begin{equation}
\frac{\partial{\mathcal{L}<em>{content}}}{\partial{F^l</em>{ij}}}=\left{
\begin{aligned}
& (F^l - P^l)<em>{ij} & if \ F^l</em>{ij} > 0 \
& 0 & if \ F^l_{ij} &lt; 0
\end{aligned}
\right.
\end{equation}</p><p>from which the gradient with respect to the image $\vec{x}$ can be computed using standard error back-propagation.</p><p>When Convolutional Neural Networks are trained on object recongnition, they develop a representation of the image that makes object information increasingly explicit along the processing hierarchy. Higher layers in the network capture the high-level <em>content</em> in terms of objects and their arrangement in the input image but do not constrain the exact pixel values of the reconstruction very much. We therefore refer to the feature responses in higher layers of the network as the <em>content representation</em>.</p><h2 id=style-representation>style representation</h2><p>To obtain a representation of the style of an input image, we use a feature space designed to capture texture information. This feature space can be built on top of the filter responses in any layer of the network. It consists of the correlations between the different filter responses, where the expecation is taken over the spatial extent of the feature maps. These feature correlations are given by the Gram matrix $G^l \in \mathcal{R}^{N_l \times N_l}$, where $G^l_{ij}$ is the inner product between the vecotrized feature maps $i$ and $j$ in layer $l$:</p>$$G^l\_{ij}=\sum\_kF^l\_{ik}F^l\_{jk}.$$<p>By inducing the feature corelations of multiple layers, we obtain a stationary, multi-scale representation of the input image, which captures its texture information but not the global arrangement. Again, we can visualise the information captured by these style feature spaces built on different layers of the network by constructing an image that matches the style representation of a given input image. This is done by using gradient descent from a white noise image to minimise the mean-squared distance between the entries of the Gram matrices from the original image and the Gram matrices of the image to be generated.
Let $\vec{a}$ and $\vec{x}$ be the original image and the image that is generated, and $A^l$ and $G^l$ their respective style representation in layer $l$. The contribution of layer $l$ to the toal loss is then</p>$$E\_l = \frac{1}{4N^2\_lM^2\_l}\sum\_{i,j}(G^l\_{ij} - A^l\_{ij})^2$$<p>and the total style loss is</p>$$\mathcal{L}\_{style}(\vec{a}, \vec{x})=\sum^L\_{l=0}w\_lE\_l,$$<p>where $w_L$ are weighting factors of the contribution of each layer to the total loss (see below for specific values of $w_l$ in our results). The derivative of $E_l$ with respect to the activations in layer $l$ can be computed analytically:</p><p>\begin{equation}
\frac{\partial{E_l}}{\partial{F^l_{ij}}}=\left{
\begin{aligned}
& \frac{1}{N^2_lM^2_l}((F^l)^T(G^l-A^l))<em>{ji} & if \ F^l</em>{ij} > 0 \
& 0 & if \ F^l_{ij} &lt; 0
\end{aligned}
\right.
\end{equation}
The gradient of $E_l$ with respect to the pixel values $\vec{x}$ can be readily computed using standard error back-propagation.</p><h2 id=style-transfer>style transfer</h2><p>To transfer the style of an artwork $\vec{a}$ onto a photograph $\vec{p}$ we synthesise a new image that simultaneously matches the content representation of $\vec{p}$ and the style representation of $\vec{a}$. Thus we jointly minimise the distance of the feature representations of a white noise image fron the content representation of the photograph in one layer and the style representation of the painting defined on a numebr of layers of the Convolutional Neural Network. The loss function we minimise is</p>$$\mathcal{L}\_{total}(\vec{p}, \vec{a}, \vec{x})=\alpha \mathcal{L}\_{content}(\vec{p}, \vec{x}) + \beta \mathcal{L}\_{style}(\vec{a}, \vec{x})$$<p>where $\alpha$ and $\beta$ are the weighting factors for content and style reconstruction, respectively. The gradient with respect to the pixel values $\frac{\partial{\mathcal{L}_{total}}}{\partial{\vec{x}}}$ can be used as input for some numerical optimisation strategy. Here we use <strong>L-BFGS</strong>, which we found to work best for image synthesis. To extract image information on comparable scales, we always resized the style image to the same size as the content image before computing its feature representations.</p><h1 id=results>Results</h1><h2 id=trade-off-between-content-and-style-matching>Trade-off between content and style matching</h2><p>Since the loss function we minimise during image synthesis is a linear combination between the loss functions for content and style respectively, we can smoothly regulate the emphasis on either reconstructing the content or the style(Fig4).
<img src=/blog/images/image-style-transfer-using-convolutional-neural-networks/Fig4.PNG loading=lazy alt=Fig4>
Figure 4. Relative weighting of matching content and style of the respective source images. The ratio $\alpha / \beta$ between matching the content and matching the style increases from top left to bottom right. A high emphasis on the style effectively produces a texturised version of the style image(top left). A high emphasis on the content produces an image with only little stylisation(bottom right). In practice one can smoothly interpolate between the two extremes.</p><h2 id=effect-of-different-layers-of-the-convolutional-neural-network>Effect of different layers of the Convolutional Neural Network</h2><p><img src=/blog/images/image-style-transfer-using-convolutional-neural-networks/Fig5.PNG loading=lazy alt=Fig5>
Figure 5. The effect of matching the content representation in different layers of the network. Matching the content on layer &lsquo;conv2_2&rsquo; preserves much of the fine structure of the original photograph and the synthesised image looks as if the texture of the painting is simply blended over the photograph(middle). When matching the content on layer &lsquo;conv4_2&rsquo; the texture of the painting and the content of the photograph merge together such that the content of photograph is displayed in the style of the painting(bottom). Both images were generated with the same choice of parameters($\alpha / \beta = 1 \times 10^{-3}$). The painting that served as the style image is shown in the bottom left corner and is name <i>Jesuiten â…¢</i> by Lyonel Feininger, 1915.
Another important factor in the image synthesis process is the choice of layers to match the content and style representation on. As outlined above, the style representation is a multi-scale representation that includes multiple layers of the neural network. The number and position of these layers determines the local scale on which the style is matched, leading to different visual experiences. We find that matching the style representations up to higher layers in the network preserves local images structures an increasingly large scale, leading to a smoother and more continuous visual experience. Thus, the visually most appealing images are usually created by matching the style representation up to high layers in the network, which is why for all images shown we match the style features in layers &lsquo;conv1_1&rsquo;, &lsquo;conv2_1&rsquo;, &lsquo;conv3_1&rsquo;, &lsquo;conv4_1&rsquo;and &lsquo;conv5_1&rsquo; of the network.
To analyse the effect of using different layers to match the content features, we present a style transfer result obtained by stylising a photograph with the same artwork and parameter configuration ($\alpha / \beta = 1 \times 10^{-3}$), but in one matching the content features on layer &lsquo;conv2_2&rsquo; and in the other on layer &lsquo;conv4_2&rsquo;(Fig5). When matching the content on a lower layer of the network, the algorithm matches much of the detailed pixel information in the photograph and the generated image appears as if the texture of the artwork is merely blended over the photograph(Fig5, middle). In contrast, when matching the content features on a higher layer of the network, deatiled pixel information of the photograph is not as strongly constraint and the texture of the artwork and the content of the photograph are properly merged. That is, the fine structure of the image, for example the edges and colour map, is altered such that it agrees with the style of the artwork while displaying the content of the photograph(Fig5, bottom).</p><h2 id=initialisation-of-gradient-descent>Initialisation of gradient descent</h2><p><img src=/blog/images/image-style-transfer-using-convolutional-neural-networks/Fig6.PNG loading=lazy alt=Fig6>
Figure 6. Initialisation of the gradient descent. <b>A</b> Initialised from the content image. <b>B</b> Initialised from the style image. <b>C</b> Four samples of images initialised from different white noise images. For all images the ratio $\alpha / \beta$ was equal to $1 \times 10^{-3}$
We have initialised all images shown so far with white noise. However, one could also initialise the image synthesis with either the content image or the style image. We explored these two alternatives(Fig6 A, B): although they bias the final image somewhat towards the spatial structure of the initialisation, the different intialisation do not seem to have a strong effect on the outcome of the synthesis procedure. It should be noted that only initialising with noise allows to generate an arbitrary number of new images(Fig6 C). Initialising with a fixed image always deterministically leads to the same outcome (up to stochasticity in the gradient descent procedure).</p><h1 id=implementation>implementation</h1><p>å…³äºå®ç°çš„éƒ¨åˆ†ï¼Œæˆ‘è‡ªå·±ç”¨mxnetå®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯å‘ç°å’Œmxnetçš„exampleé‡Œé¢ç»™çš„éå¸¸ä¸ä¸€æ ·ã€‚åœ¨ä»–ä»¬çš„å®ç°é‡Œé¢æåˆ°äº†Total variation denoisingã€‚è€Œä¸”ï¼Œè®ºæ–‡ä¸­çš„loss functionæ˜¯sum of squareï¼Œè€Œå›¾2ä¸­ç»™å‡ºæ˜¯MSEï¼Œå–äº†ä¸ªå¹³å‡å€¼ã€‚æˆ‘å®ç°æ˜¯æ—¶å€™æ²¡æœ‰å–å¹³å‡ï¼Œå¯¼è‡´losså¾ˆå¤§ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥è®­ç»ƒã€‚ä½†æ˜¯è‡ªå·±å®ç°çš„æ¢¯åº¦ä¸‹é™å¾ˆéš¾æ”¶æ•›ï¼Œéœ€è¦å¯¹æ¢¯åº¦è¿›è¡Œå½’ä¸€åŒ–ï¼Œåæ¥ä½¿ç”¨MXNetçš„gluonçš„Trainerè®­ç»ƒä¼šæ¯”åŸæ¥å¥½å¾ˆå¤šã€‚</p><h2 id=total-variation-denoising>Total variation denoising</h2><p>In signal processing, total variation denoising, also known as total variation regularization, is a process, most often used in digital image processing, that has applications in noise removal.
<img src=/blog/images/image-style-transfer-using-convolutional-neural-networks/ROF_Denoising_Example.png loading=lazy alt="â€œTotal variation denoisingâ€">
Example of application of the Rudin et al.[1] total variation denoising technique to an image corrupted by Gaussian noise. This example created using demo_tv.m by Guy Gilboa, see external links.
It is based on the principle that signals with excessive and possibly spurious detail have high total variation, that is, the integral of the absolute gradient of the signla is high. According to this principle, reducing the total variation of the signal subject to it being a close match to the original signal, removes unwanted detail whilst preserving important details such as edges. The concept was pioneered by Rudin, Osher, and Fatemi in 1992 and so is today known as the ROF model.
This noise removal technique has advantages over simple techniques such as linear smoothing or median filtering which reduce noise but at the same time smooth away edges to a greater or lesser degree. By contrast, total variation denoising is remarkably effective at simultaneously preserving edges whilst smoothing away noise in flat regions, even at low signal-to-noise ratios.</p><h3 id=1d-signal-series>1D signal series</h3><p>For a digital signal $y_n$, we can, for example, define the total variation as:</p>$$V(y)=\sum\_n\vert y\_{n+1}-y\_n\vert$$<p>Given an input signal $x_n$, the goal of total variation denoising is to find an approximation, call it $y_n$, that has smaller total variation than $x_n$ but is &ldquo;close&rdquo; to $x_n$. One measure of closeness is the sum of square errors:</p>$$E(x, y)=\frac{1}{2}\sum\_n(x\_n - y\_n)^2$$<p>So the total variation denoising problem amounts to minimizing the following discrete functional over the signal $y_n$:</p>$$E(x, y) + \lambda V(y)$$<p>By differentiating this functional with respect to $y_n$, we can derive a corresponding Euler-lagrange equation, that can be numerically integrated with the original signal $x_n$ as initial condition. This was the original approach. Alternatively, since this is a convex functional, techniques from convex optimization can be used to minimize it and find the solution $y_n$.</p><h3 id=regularization-properties>Regularization properties</h3><p>The regularization parameter $\lambda $ plays a critical role in the denoising process. When $\lambda = 0$, there is no smoothing and the result is the same as minimizing the sum of squares. As $\lambda \to \infty $, however, the total variation term plays an increasingly strong role, which forces the result to have smaller total variation, at the expanse of being less like the input (noisy) signal. Thus, the choice of regularization parameter is critical to achieving just the right amount of noise removal.</p><h3 id=2d-signal-images>2D signal images</h3><p>We now consider 2D signals $y$, such as images. The total variation norm proposed by the 1992 paper is</p>$$V(y) = \sum\_{i,j}\sqrt{\vert y\_{i+1,j}-y\_{i,j}\vert ^2 + \vert y\_{i, j+1} - y\_{i, j}\vert ^2}$$<p>and is isotropic and not differentiable. A variation that is sometimes used, since it may sometimes be easier to minimize, is an anisotropic version</p>$$V\_{aniso}(y) = \sum\_{i,j}\sqrt{\vert y\_{i+1,j}-y\_{i,j}\vert ^2} + \sqrt{\vert y\_{i,j+1} - y\_{i,j}\vert ^2} = \sum\_{i,j}\vert y\_{i+1,j}-y\_{i,j}\vert + \vert y\_{i,j+1}-y\_{i,j}\vert $$<p>The standard total variation denoising problem is still of the form</p>$$\min\_yE(x,y)+\lambda V(y)$$<p>where $E$ is the 2D L2 norm. In contrast to the 1D case, solving this denoising is non-trivial. A recent algorithm that solves this is known as the primal dual method.
Due in part to much research in compressed sensing in the mid-2000s, there are many algorithms, such as the split-Bregman method, that solve variants of this problem.</p><p>ä¸è¿‡æˆ‘ä¸ªäººåœ¨å®ç°çš„æ—¶å€™ï¼Œå®ç°äº†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯å¢åŠ äº†total variation denoisingï¼Œå¦ä¸€ä¸ªæ˜¯æ²¡å¢åŠ total variation denoisingçš„aã€‚
ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mxnet</span> <span class=k>as</span> <span class=nn>mx</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skimage</span> <span class=kn>import</span> <span class=n>io</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skimage</span> <span class=kn>import</span> <span class=n>transform</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet</span> <span class=kn>import</span> <span class=n>nd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>matplotlib</span> <span class=n>inline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet.gluon.model_zoo</span> <span class=kn>import</span> <span class=n>vision</span> <span class=k>as</span> <span class=n>models</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet.gluon</span> <span class=kn>import</span> <span class=n>nn</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet</span> <span class=kn>import</span> <span class=n>autograd</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet.gluon</span> <span class=kn>import</span> <span class=n>Trainer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mxnet.gluon</span> <span class=kn>import</span> <span class=n>Parameter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl><span class=n>warnings</span><span class=o>.</span><span class=n>filterwarnings</span><span class=p>(</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>content_image_path</span> <span class=o>=</span> <span class=s1>&#39;../../gluon-tutorial-zh/img/pine-tree.jpg&#39;</span>
</span></span><span class=line><span class=cl><span class=n>style_image_path</span> <span class=o>=</span> <span class=s1>&#39;the_starry_night.jpg&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rgb_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>rgb_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>preprocessing</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>image_shape</span><span class=p>,</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>cpu</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=n>newImage</span> <span class=o>=</span> <span class=n>transform</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>image_shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>newImage</span> <span class=o>=</span> <span class=n>newImage</span><span class=o>.</span><span class=n>transpose</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>newImage</span> <span class=o>=</span> <span class=p>(</span><span class=n>newImage</span> <span class=o>-</span> <span class=n>rgb_mean</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span> <span class=o>/</span> <span class=n>rgb_std</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nd</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>newImage</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>postprocessing</span><span class=p>(</span><span class=n>img</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>newImage</span> <span class=o>=</span> <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>asnumpy</span><span class=p>()</span> <span class=o>*</span> <span class=n>rgb_std</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>rgb_mean</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>newImage</span><span class=o>.</span><span class=n>transpose</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_net</span><span class=p>(</span><span class=n>style_layers</span><span class=p>,</span> <span class=n>content_layers</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>net</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>HybridSequential</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>style_layers</span> <span class=o>+</span> <span class=n>content_layers</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>net</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>pretrained_net</span><span class=o>.</span><span class=n>features</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>net</span><span class=o>.</span><span class=n>hybridize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>net</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_features</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>img</span><span class=p>,</span> <span class=n>content_layers</span><span class=p>,</span> <span class=n>style_layers</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>content_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>style_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>net</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>net</span><span class=p>[</span><span class=n>i</span><span class=p>](</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>content_layers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>style_layers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>style_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>content_results</span><span class=p>,</span> <span class=n>style_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>content_loss</span><span class=p>(</span><span class=n>content_results</span><span class=p>,</span> <span class=n>content_target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>losses</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>content_results</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>content_results</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>content_target</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>square</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nd</span><span class=o>.</span><span class=n>add_n</span><span class=p>(</span><span class=o>*</span><span class=n>losses</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gram</span><span class=p>(</span><span class=n>feature_map</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>N</span> <span class=o>=</span> <span class=n>feature_map</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>M</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=n>feature_map</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=n>new_feature_map</span> <span class=o>=</span> <span class=n>feature_map</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=n>N</span><span class=p>,</span> <span class=n>M</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nd</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>new_feature_map</span><span class=p>,</span> <span class=n>new_feature_map</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>style_loss</span><span class=p>(</span><span class=n>style_results</span><span class=p>,</span> <span class=n>style_target</span><span class=p>,</span> <span class=n>weights</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>losses</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>style_results</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=p>(</span><span class=n>gram</span><span class=p>(</span><span class=n>style_results</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>-</span> <span class=n>style_target</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>square</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> \
</span></span><span class=line><span class=cl>            <span class=o>/</span> <span class=p>(</span><span class=mi>4</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=n>style_results</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>:]))</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>weights</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nd</span><span class=o>.</span><span class=n>add_n</span><span class=p>(</span><span class=o>*</span><span class=n>losses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_loss</span><span class=p>(</span><span class=n>content_loss_result</span><span class=p>,</span> <span class=n>style_loss_result</span><span class=p>,</span> <span class=n>ratio</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>content_loss_result</span> <span class=o>*</span> <span class=n>ratio</span> <span class=o>+</span> <span class=n>style_loss_result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>style_layers</span> <span class=o>=</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>34</span><span class=p>]</span> <span class=c1># è¿™é‡Œä¸è®ºæ–‡ä¸åŒï¼Œæˆ‘é€‰çš„å±‚æ¯”è®ºæ–‡ç»™å‡ºçš„æ›´æ·±ï¼Œä¸ºäº†æ•æ‰åˆ°æ›´æŠ½è±¡çš„style</span>
</span></span><span class=line><span class=cl><span class=n>content_layers</span> <span class=o>=</span> <span class=p>[</span><span class=mi>21</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=o>=</span> <span class=n>get_net</span><span class=p>(</span><span class=n>style_layers</span><span class=p>,</span> <span class=n>content_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>content_image</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>content_image_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>style_image</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>style_image_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pretrained_net</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>vgg19</span><span class=p>(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ctx</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>gpu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=o>.</span><span class=n>collect_params</span><span class=p>()</span><span class=o>.</span><span class=n>reset_ctx</span><span class=p>(</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>content_img</span> <span class=o>=</span> <span class=n>preprocessing</span><span class=p>(</span><span class=n>content_image</span><span class=p>,</span> <span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=mi>300</span><span class=p>),</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>style_img</span> <span class=o>=</span> <span class=n>preprocessing</span><span class=p>(</span><span class=n>style_image</span><span class=p>,</span> <span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=mi>300</span><span class=p>),</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>Parameter</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=n>content_img</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>output</span><span class=o>.</span><span class=n>initialize</span><span class=p>(</span><span class=n>ctx</span><span class=o>=</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># output.set_data(nd.random_normal(shape = content_img.shape).abs())</span>
</span></span><span class=line><span class=cl><span class=n>output</span><span class=o>.</span><span class=n>set_data</span><span class=p>(</span><span class=n>content_img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>content_img_result</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>extract_features</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>content_img</span><span class=p>,</span> <span class=n>content_layers</span><span class=p>,</span> <span class=n>style_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>style_img_result</span> <span class=o>=</span> <span class=n>extract_features</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>style_img</span><span class=p>,</span> <span class=n>content_layers</span><span class=p>,</span> <span class=n>style_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>content_results</span><span class=p>,</span> <span class=n>style_results</span> <span class=o>=</span> <span class=n>extract_features</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>output</span><span class=o>.</span><span class=n>data</span><span class=p>(),</span> <span class=n>content_layers</span><span class=p>,</span> <span class=n>style_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>style_target</span> <span class=o>=</span> <span class=p>[</span><span class=n>gram</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>style_img_result</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>trainer</span> <span class=o>=</span> <span class=n>Trainer</span><span class=p>([</span><span class=n>output</span><span class=p>],</span> <span class=s1>&#39;adam&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=p>{</span><span class=s1>&#39;learning_rate&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span> <span class=s1>&#39;beta1&#39;</span><span class=p>:</span> <span class=mf>0.9</span><span class=p>,</span> <span class=s1>&#39;beta2&#39;</span><span class=p>:</span> <span class=mf>0.99</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>autograd</span><span class=o>.</span><span class=n>record</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>content_results</span><span class=p>,</span> <span class=n>style_results</span> <span class=o>=</span> <span class=n>extract_features</span><span class=p>(</span><span class=n>net</span><span class=p>,</span> <span class=n>output</span><span class=o>.</span><span class=n>data</span><span class=p>(),</span> <span class=n>content_layers</span><span class=p>,</span> <span class=n>style_layers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=n>get_loss</span><span class=p>(</span><span class=n>content_loss</span><span class=p>(</span><span class=n>content_results</span><span class=p>,</span> <span class=n>content_img_result</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=n>style_loss</span><span class=p>(</span><span class=n>style_results</span><span class=p>,</span> <span class=n>style_target</span><span class=p>,</span> <span class=p>[</span><span class=mf>0.2</span><span class=p>]</span> <span class=o>*</span> <span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=mf>1e-4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>epoch</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>loss</span><span class=o>.</span><span class=n>asscalar</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>trainer</span><span class=o>.</span><span class=n>step</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>postprocessing</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>data</span><span class=p>()))</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œåœ¨å®ç°çš„æ—¶å€™ï¼Œä½¿ç”¨äº†è¿™ä¸ª2Då›¾åƒçš„total variation denoisingï¼Œä¹Ÿå°±æ˜¯ï¼Œæ¯ä¸ªåƒç´ åº”å°½å¯èƒ½çš„ä¸å·¦ä¾§å’Œä¸Šæ–¹çš„åƒç´ ç›¸è¿‘ã€‚æ‰€ä»¥æœ€åçš„ä¼˜åŒ–ç›®æ ‡æ˜¯ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯content lossï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯style lossï¼Œç¬¬ä¸‰éƒ¨åˆ†æ˜¯total variation lossã€‚
ç ”ç©¶ä¸€ä¸‹mxnetç»™å‡ºçš„example
model_vgg19.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Licensed to the Apache Software Foundation (ASF) under one</span>
</span></span><span class=line><span class=cl><span class=c1># or more contributor license agreements.  See the NOTICE file</span>
</span></span><span class=line><span class=cl><span class=c1># distributed with this work for additional information</span>
</span></span><span class=line><span class=cl><span class=c1># regarding copyright ownership.  The ASF licenses this file</span>
</span></span><span class=line><span class=cl><span class=c1># to you under the Apache License, Version 2.0 (the</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;License&#34;); you may not use this file except in compliance</span>
</span></span><span class=line><span class=cl><span class=c1># with the License.  You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#   http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing,</span>
</span></span><span class=line><span class=cl><span class=c1># software distributed under the License is distributed on an</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;AS IS&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
</span></span><span class=line><span class=cl><span class=c1># KIND, either express or implied.  See the License for the</span>
</span></span><span class=line><span class=cl><span class=c1># specific language governing permissions and limitations</span>
</span></span><span class=line><span class=cl><span class=c1># under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>find_mxnet</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mxnet</span> <span class=k>as</span> <span class=nn>mx</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ConvExecutor</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;ConvExecutor&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;executor&#39;</span><span class=p>,</span> <span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=s1>&#39;data_grad&#39;</span><span class=p>,</span> <span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>,</span> <span class=s1>&#39;arg_dict&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_symbol</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># declare symbol</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv1_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv1_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu1_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu1_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv1_1</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv1_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv1_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu1_1</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu1_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu1_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv1_2</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Pooling</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;pool1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu1_2</span> <span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>pool_type</span><span class=o>=</span><span class=s1>&#39;avg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv2_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv2_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>pool1</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu2_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu2_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv2_1</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv2_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv2_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu2_1</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu2_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu2_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv2_2</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Pooling</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;pool2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu2_2</span> <span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>pool_type</span><span class=o>=</span><span class=s1>&#39;avg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv3_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv3_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>pool2</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu3_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu3_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv3_1</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv3_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv3_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu3_1</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu3_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu3_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv3_2</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv3_3</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv3_3&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu3_2</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu3_3</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu3_3&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv3_3</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv3_4</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv3_4&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu3_3</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu3_4</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu3_4&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv3_4</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool3</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Pooling</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;pool3&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu3_4</span> <span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>pool_type</span><span class=o>=</span><span class=s1>&#39;avg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv4_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv4_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>pool3</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu4_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu4_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv4_1</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv4_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv4_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu4_1</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu4_2</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu4_2&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv4_2</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv4_3</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv4_3&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu4_2</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu4_3</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu4_3&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv4_3</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv4_4</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv4_4&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu4_3</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu4_4</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu4_4&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv4_4</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool4</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Pooling</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;pool4&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>relu4_4</span> <span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span> <span class=n>pool_type</span><span class=o>=</span><span class=s1>&#39;avg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conv5_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;conv5_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>pool4</span> <span class=p>,</span> <span class=n>num_filter</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>workspace</span><span class=o>=</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>relu5_1</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>Activation</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;relu5_1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>conv5_1</span> <span class=p>,</span> <span class=n>act_type</span><span class=o>=</span><span class=s1>&#39;relu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># style and content layers</span>
</span></span><span class=line><span class=cl>    <span class=n>style</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Group</span><span class=p>([</span><span class=n>relu1_1</span><span class=p>,</span> <span class=n>relu2_1</span><span class=p>,</span> <span class=n>relu3_1</span><span class=p>,</span> <span class=n>relu4_1</span><span class=p>,</span> <span class=n>relu5_1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Group</span><span class=p>([</span><span class=n>relu4_2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>style</span><span class=p>,</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_executor</span><span class=p>(</span><span class=n>style</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=n>input_size</span><span class=p>,</span> <span class=n>ctx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Group</span><span class=p>([</span><span class=n>style</span><span class=p>,</span> <span class=n>content</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># make executor</span>
</span></span><span class=line><span class=cl>    <span class=n>arg_shapes</span><span class=p>,</span> <span class=n>output_shapes</span><span class=p>,</span> <span class=n>aux_shapes</span> <span class=o>=</span> <span class=n>out</span><span class=o>.</span><span class=n>infer_shape</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>input_size</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>input_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>arg_names</span> <span class=o>=</span> <span class=n>out</span><span class=o>.</span><span class=n>list_arguments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>arg_dict</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>arg_names</span><span class=p>,</span> <span class=p>[</span><span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>shape</span><span class=p>,</span> <span class=n>ctx</span><span class=o>=</span><span class=n>ctx</span><span class=p>)</span> <span class=k>for</span> <span class=n>shape</span> <span class=ow>in</span> <span class=n>arg_shapes</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>arg_dict</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>ctx</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>    <span class=c1># init with pretrained weight</span>
</span></span><span class=line><span class=cl>    <span class=n>pretrained</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;./model/vgg19.params&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>arg_names</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;data&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;arg:&#34;</span> <span class=o>+</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>pretrained</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pretrained</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>arg_dict</span><span class=p>[</span><span class=n>name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Skip argument </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span> <span class=o>=</span> <span class=n>out</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=n>ctx</span><span class=o>=</span><span class=n>ctx</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=n>arg_dict</span><span class=p>,</span> <span class=n>args_grad</span><span class=o>=</span><span class=n>grad_dict</span><span class=p>,</span> <span class=n>grad_req</span><span class=o>=</span><span class=s2>&#34;write&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ConvExecutor</span><span class=p>(</span><span class=n>executor</span><span class=o>=</span><span class=n>executor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>data</span><span class=o>=</span><span class=n>arg_dict</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>data_grad</span><span class=o>=</span><span class=n>grad_dict</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>style</span><span class=o>=</span><span class=n>executor</span><span class=o>.</span><span class=n>outputs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>=</span><span class=n>executor</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>arg_dict</span><span class=o>=</span><span class=n>arg_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_model</span><span class=p>(</span><span class=n>input_size</span><span class=p>,</span> <span class=n>ctx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>style</span><span class=p>,</span> <span class=n>content</span> <span class=o>=</span> <span class=n>get_symbol</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get_executor</span><span class=p>(</span><span class=n>style</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=n>input_size</span><span class=p>,</span> <span class=n>ctx</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>nstyle.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Licensed to the Apache Software Foundation (ASF) under one</span>
</span></span><span class=line><span class=cl><span class=c1># or more contributor license agreements.  See the NOTICE file</span>
</span></span><span class=line><span class=cl><span class=c1># distributed with this work for additional information</span>
</span></span><span class=line><span class=cl><span class=c1># regarding copyright ownership.  The ASF licenses this file</span>
</span></span><span class=line><span class=cl><span class=c1># to you under the Apache License, Version 2.0 (the</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;License&#34;); you may not use this file except in compliance</span>
</span></span><span class=line><span class=cl><span class=c1># with the License.  You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#   http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing,</span>
</span></span><span class=line><span class=cl><span class=c1># software distributed under the License is distributed on an</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;AS IS&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
</span></span><span class=line><span class=cl><span class=c1># KIND, either express or implied.  See the License for the</span>
</span></span><span class=line><span class=cl><span class=c1># specific language governing permissions and limitations</span>
</span></span><span class=line><span class=cl><span class=c1># under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>find_mxnet</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mxnet</span> <span class=k>as</span> <span class=nn>mx</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>importlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skimage</span> <span class=kn>import</span> <span class=n>io</span><span class=p>,</span> <span class=n>transform</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skimage.restoration</span> <span class=kn>import</span> <span class=n>denoise_tv_chambolle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CallbackData</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;CallbackData&#39;</span><span class=p>,</span> <span class=n>field_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;eps&#39;</span><span class=p>,</span><span class=s1>&#39;epoch&#39;</span><span class=p>,</span><span class=s1>&#39;img&#39;</span><span class=p>,</span><span class=s1>&#39;filename&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_args</span><span class=p>(</span><span class=n>arglist</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s1>&#39;neural style&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># é€‰æ‹©æ¨¡å‹ï¼Œé»˜è®¤æ˜¯VGG19</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--model&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;vgg19&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>choices</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;vgg&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span> <span class=o>=</span> <span class=s1>&#39;the pretrained model to use&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å†…å®¹å›¾ç‰‡çš„è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--content-image&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;input/IMG_4343.jpg&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the content image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># é£æ ¼å›¾ç‰‡çš„è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--style-image&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;input/starry_night.jpg&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the style image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># åœæ­¢è¿­ä»£çš„é˜ˆå€¼ï¼Œè‹¥relative changeå°äºè¿™ä¸ªæ•°å°±åœæ­¢è¿­ä»£</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--stop-eps&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mf>.005</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;stop if the relative chanage is less than eps&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å†…å®¹å›¾ç‰‡åœ¨lossä¸Šçš„æƒé‡</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--content-weight&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the weight for the content image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># é£æ ¼å›¾ç‰‡åœ¨lossä¸Šçš„æƒé‡</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--style-weight&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the weight for the style image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># total variationåœ¨lossä¸Šçš„æƒé‡</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--tv-weight&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mf>1e-2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the magtitute on TV loss&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æœ€å¤§è¿­ä»£æ¬¡æ•°</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--max-num-epochs&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the maximal number of training epochs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># </span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--max-long-edge&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;resize the content image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># åˆå§‹çš„å­¦ä¹ ç‡</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--lr&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mf>.001</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the initial learning rate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ä½¿ç”¨å“ªå—GPU</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--gpu&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;which gpu card to use, -1 means using cpu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¾“å‡ºå›¾åƒçš„è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--output_dir&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;output/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the output image&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ¯å¤šå°‘è½®ä¿å­˜ä¸€æ¬¡å½“å‰çš„è¾“å‡ºç»“æœ</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--save-epochs&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;save the output every n epochs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># </span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--remove-noise&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>float</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mf>.02</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;the magtitute to remove noise&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ¯è¿­ä»£å¤šå°‘è½®å‡å°ä¸€ä¸‹å­¦ä¹ ç‡</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--lr-sched-delay&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>75</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;how many epochs between decreasing learning rate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å­¦ä¹ ç‡è¡°å‡å› å­</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--lr-sched-factor&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>help</span><span class=o>=</span><span class=s1>&#39;factor to decrease learning rate on schedule&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>arglist</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>(</span><span class=n>arglist</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>PreprocessContentImage</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>long_edge</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    å†…å®¹å›¾ç‰‡é¢„å¤„ç†
</span></span></span><span class=line><span class=cl><span class=s1>    Parameter: path, str, å›¾ç‰‡è·¯å¾„
</span></span></span><span class=line><span class=cl><span class=s1>               long_edge, int, float, str(float), å›¾åƒè¢«ç¼©æ”¾åé•¿è¾¹çš„é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–å›¾ç‰‡ï¼Œä½¿ç”¨skimage.io.imreadï¼Œè¿”å›numpy.ndarray</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># img.shapeå‰ä¸¤ä¸ªæ•°åˆ†åˆ«æ˜¯å¤šå°‘è¡Œå’Œå¤šå°‘åˆ—ï¼Œç¬¬ä¸‰ä¸ªæ•°æ˜¯channelæ•°</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;load the content image, size = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># resizeä¸€ä¸‹å›¾ç‰‡ï¼Œresizeåçš„èŒƒå›´åœ¨0åˆ°1å†…</span>
</span></span><span class=line><span class=cl>    <span class=n>factor</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>long_edge</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>new_size</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>factor</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>factor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>resized_img</span> <span class=o>=</span> <span class=n>transform</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>new_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ä¹˜ä»¥256æ¢å¤åˆ°åŸæ¥çš„åŒºé—´</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>resized_img</span><span class=p>)</span> <span class=o>*</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># swap axes to make image from (224, 224, 3) to (3, 224, 224)</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># sub meanï¼Œè¿™é‡Œçš„å‡å€¼åº”è¯¥æ˜¯ImageNetæ•°æ®é›†åœ¨RGBä¸‰é€šé“ä¸Šçš„å‡å€¼</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>123.68</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>116.779</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>103.939</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;resize the content image to </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>new_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>sample</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>sample</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>PreprocessStyleImage</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>shape</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    å¯¹é£æ ¼å›¾ç‰‡çš„é¢„å¤„ç†
</span></span></span><span class=line><span class=cl><span class=s1>    Parameter: path, str, å›¾åƒè·¯å¾„
</span></span></span><span class=line><span class=cl><span class=s1>               shape, tuple, é•¿åº¦ä¸º4çš„tupleï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ å’Œç¬¬å››ä¸ªå…ƒç´ æ˜¯content imageçš„size
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>resized_img</span> <span class=o>=</span> <span class=n>transform</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=p>(</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>shape</span><span class=p>[</span><span class=mi>3</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>resized_img</span><span class=p>)</span> <span class=o>*</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>123.68</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>116.779</span>
</span></span><span class=line><span class=cl>    <span class=n>sample</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=p>:]</span> <span class=o>-=</span> <span class=mf>103.939</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>sample</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>sample</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>PostprocessImage</span><span class=p>(</span><span class=n>img</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    å¯¹å›¾åƒçš„åå¤„ç†
</span></span></span><span class=line><span class=cl><span class=s1>    Parameter: img, numpy.ndarray
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>3</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:]</span> <span class=o>+=</span> <span class=mf>123.68</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span> <span class=o>+=</span> <span class=mf>116.779</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=p>:]</span> <span class=o>+=</span> <span class=mf>103.939</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>swapaxes</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># clipå‡½æ•°æ˜¯ç”¨æ¥ç æ‰å°äºä¸‹ç•Œå’Œå¤§äºä¸Šå±Šçš„æ•°çš„</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>img</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>&#39;uint8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>SaveImage</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>remove_noise</span><span class=o>=</span><span class=mf>0.</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    ä¿å­˜å›¾ç‰‡
</span></span></span><span class=line><span class=cl><span class=s1>    Parameter: img, numpy.ndarray
</span></span></span><span class=line><span class=cl><span class=s1>               filename, str
</span></span></span><span class=line><span class=cl><span class=s1>               remove_noise, float, default=0., 
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;save output to </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>PostprocessImage</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>remove_noise</span> <span class=o>!=</span> <span class=mf>0.0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=n>denoise_tv_chambolle</span><span class=p>(</span><span class=n>out</span><span class=p>,</span> <span class=n>weight</span><span class=o>=</span><span class=n>remove_noise</span><span class=p>,</span> <span class=n>multichannel</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>imsave</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>style_gram_symbol</span><span class=p>(</span><span class=n>input_size</span><span class=p>,</span> <span class=n>style</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    Parameter: input_size, tuple, length=2, è¡¨ç¤ºcontent imageçš„size
</span></span></span><span class=line><span class=cl><span class=s1>               style, mx.sym.Groupï¼Œé‡Œé¢æ˜¯styleå¯¹åº”çš„å±‚
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>output_shapes</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>style</span><span class=o>.</span><span class=n>infer_shape</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>input_size</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>input_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>gram_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_scale</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>style</span><span class=o>.</span><span class=n>list_outputs</span><span class=p>())):</span>
</span></span><span class=line><span class=cl>        <span class=n>shape</span> <span class=o>=</span> <span class=n>output_shapes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Reshape</span><span class=p>(</span><span class=n>style</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>target_shape</span><span class=o>=</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>:]))))</span>
</span></span><span class=line><span class=cl>        <span class=c1># use fully connected to quickly do dot(x, x^T)</span>
</span></span><span class=line><span class=cl>        <span class=n>gram</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>FullyConnected</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>no_bias</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>num_hidden</span><span class=o>=</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>gram_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>gram</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># grad_scale c*h*w*c</span>
</span></span><span class=line><span class=cl>        <span class=n>grad_scale</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span> <span class=o>*</span> <span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Group</span><span class=p>(</span><span class=n>gram_list</span><span class=p>),</span> <span class=n>grad_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_loss</span><span class=p>(</span><span class=n>gram</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>gram_loss</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>gram</span><span class=o>.</span><span class=n>list_outputs</span><span class=p>())):</span>
</span></span><span class=line><span class=cl>        <span class=n>gvar</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=s2>&#34;target_gram_</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gram_loss</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>square</span><span class=p>(</span><span class=n>gvar</span> <span class=o>-</span> <span class=n>gram</span><span class=p>[</span><span class=n>i</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>    <span class=n>cvar</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=s2>&#34;target_content&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>content_loss</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>square</span><span class=p>(</span><span class=n>cvar</span> <span class=o>-</span> <span class=n>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Group</span><span class=p>(</span><span class=n>gram_loss</span><span class=p>),</span> <span class=n>content_loss</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_tv_grad_executor</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>tv_weight</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;create TV gradient executor with input binded on img
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>tv_weight</span> <span class=o>&lt;=</span> <span class=mf>0.0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>nchannel</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>simg</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=s2>&#34;img&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>skernel</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=s2>&#34;kernel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>channels</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>SliceChannel</span><span class=p>(</span><span class=n>simg</span><span class=p>,</span> <span class=n>num_outputs</span><span class=o>=</span><span class=n>nchannel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Concat</span><span class=p>(</span><span class=o>*</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>mx</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>Convolution</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>channels</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>weight</span><span class=o>=</span><span class=n>skernel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>num_filter</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>kernel</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>pad</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                           <span class=n>no_bias</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>nchannel</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=n>kernel</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                   <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                   <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>                         <span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                         <span class=n>ctx</span><span class=p>)</span> <span class=o>/</span> <span class=mf>8.0</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>out</span> <span class=o>*</span> <span class=n>tv_weight</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;img&#34;</span><span class=p>:</span> <span class=n>img</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=s2>&#34;kernel&#34;</span><span class=p>:</span> <span class=n>kernel</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>train_nstyle</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>callback</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Train a neural style network.
</span></span></span><span class=line><span class=cl><span class=s2>    Args are from argparse and control input, output, hyper-parameters.
</span></span></span><span class=line><span class=cl><span class=s2>    callback allows for display of training progress.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># input</span>
</span></span><span class=line><span class=cl>    <span class=n>dev</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>gpu</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>gpu</span><span class=p>)</span> <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>gpu</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>mx</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>content_np</span> <span class=o>=</span> <span class=n>PreprocessContentImage</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>content_image</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>max_long_edge</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>style_np</span> <span class=o>=</span> <span class=n>PreprocessStyleImage</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>style_image</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=n>content_np</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># sizeæ˜¯å†…å®¹å›¾ç‰‡çš„å°ºå¯¸</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=n>content_np</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># model</span>
</span></span><span class=line><span class=cl>    <span class=n>Executor</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Executor&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;executor&#39;</span><span class=p>,</span> <span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=s1>&#39;data_grad&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¯¼å…¥&#39;model_vgg19.py&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>model_module</span> <span class=o>=</span>  <span class=n>importlib</span><span class=o>.</span><span class=n>import_module</span><span class=p>(</span><span class=s1>&#39;model_&#39;</span> <span class=o>+</span> <span class=n>args</span><span class=o>.</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–åˆ°styleå’Œcontentä¸¤ä¸ªmx.sym.Groupï¼Œé‡Œé¢è£…ç€styleå’Œcontentå±‚</span>
</span></span><span class=line><span class=cl>    <span class=n>style</span><span class=p>,</span> <span class=n>content</span> <span class=o>=</span> <span class=n>model_module</span><span class=o>.</span><span class=n>get_symbol</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–åˆ°æ‰€æœ‰styleå±‚çš„gramçŸ©é˜µå’Œgrad scale</span>
</span></span><span class=line><span class=cl>    <span class=n>gram</span><span class=p>,</span> <span class=n>gscale</span> <span class=o>=</span> <span class=n>style_gram_symbol</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>style</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span> <span class=o>=</span> <span class=n>model_module</span><span class=o>.</span><span class=n>get_executor</span><span class=p>(</span><span class=n>gram</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>dev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span><span class=o>.</span><span class=n>data</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>style_np</span>
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>forward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>style_array</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>style</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>style_array</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>style</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>cpu</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span><span class=o>.</span><span class=n>data</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>content_np</span>
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>forward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>content_array</span> <span class=o>=</span> <span class=n>model_executor</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>cpu</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># delete the executor</span>
</span></span><span class=line><span class=cl>    <span class=k>del</span> <span class=n>model_executor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>style_loss</span><span class=p>,</span> <span class=n>content_loss</span> <span class=o>=</span> <span class=n>get_loss</span><span class=p>(</span><span class=n>gram</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model_executor</span> <span class=o>=</span> <span class=n>model_module</span><span class=o>.</span><span class=n>get_executor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>style_loss</span><span class=p>,</span> <span class=n>content_loss</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>dev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>grad_array</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>style_array</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>style_array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>arg_dict</span><span class=p>[</span><span class=s2>&#34;target_gram_</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>grad_array</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>ones</span><span class=p>((</span><span class=mi>1</span><span class=p>,),</span> <span class=n>dev</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>style_weight</span><span class=p>)</span> <span class=o>/</span> <span class=n>gscale</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_array</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>ones</span><span class=p>((</span><span class=mi>1</span><span class=p>,),</span> <span class=n>dev</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>content_weight</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>([</span><span class=n>x</span><span class=o>.</span><span class=n>asscalar</span><span class=p>()</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>grad_array</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>content_array</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>arg_dict</span><span class=p>[</span><span class=s2>&#34;target_content&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># train</span>
</span></span><span class=line><span class=cl>    <span class=c1># initialize img with random noise</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>content_np</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>ctx</span><span class=o>=</span><span class=n>dev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>rnd</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=o>-</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lr</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>lr_scheduler</span><span class=o>.</span><span class=n>FactorScheduler</span><span class=p>(</span><span class=n>step</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>lr_sched_delay</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>factor</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>lr_sched_factor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>NAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>learning_rate</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>lr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>wd</span> <span class=o>=</span> <span class=mf>0.0001</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>momentum</span><span class=o>=</span><span class=mf>0.95</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>lr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>optim_state</span> <span class=o>=</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>create_state</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;start training arguments </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>old_img</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>dev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>clip_norm</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tv_grad_executor</span> <span class=o>=</span> <span class=n>get_tv_grad_executor</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>tv_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>max_num_epochs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>model_executor</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>forward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>model_executor</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>backward</span><span class=p>(</span><span class=n>grad_array</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gnorm</span> <span class=o>=</span> <span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>model_executor</span><span class=o>.</span><span class=n>data_grad</span><span class=p>)</span><span class=o>.</span><span class=n>asscalar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>gnorm</span> <span class=o>&gt;</span> <span class=n>clip_norm</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>model_executor</span><span class=o>.</span><span class=n>data_grad</span><span class=p>[:]</span> <span class=o>*=</span> <span class=n>clip_norm</span> <span class=o>/</span> <span class=n>gnorm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tv_grad_executor</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tv_grad_executor</span><span class=o>.</span><span class=n>forward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>optimizer</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>img</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>model_executor</span><span class=o>.</span><span class=n>data_grad</span> <span class=o>+</span> <span class=n>tv_grad_executor</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                             <span class=n>optim_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>optimizer</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>img</span><span class=p>,</span> <span class=n>model_executor</span><span class=o>.</span><span class=n>data_grad</span><span class=p>,</span> <span class=n>optim_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>new_img</span> <span class=o>=</span> <span class=n>img</span>
</span></span><span class=line><span class=cl>        <span class=n>eps</span> <span class=o>=</span> <span class=p>(</span><span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>old_img</span> <span class=o>-</span> <span class=n>new_img</span><span class=p>)</span> <span class=o>/</span> <span class=n>mx</span><span class=o>.</span><span class=n>nd</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>new_img</span><span class=p>))</span><span class=o>.</span><span class=n>asscalar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>old_img</span> <span class=o>=</span> <span class=n>new_img</span><span class=o>.</span><span class=n>copyto</span><span class=p>(</span><span class=n>dev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;epoch </span><span class=si>%d</span><span class=s1>, relative change </span><span class=si>%f</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>eps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>eps</span> <span class=o>&lt;</span> <span class=n>args</span><span class=o>.</span><span class=n>stop_eps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;eps &lt; args.stop_eps, training finished&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>callback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cbdata</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;eps&#39;</span><span class=p>:</span> <span class=n>eps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;epoch&#39;</span><span class=p>:</span> <span class=n>e</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=n>args</span><span class=o>.</span><span class=n>save_epochs</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>outfn</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>output_dir</span> <span class=o>+</span> <span class=s1>&#39;e_&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;.jpg&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>npimg</span> <span class=o>=</span> <span class=n>new_img</span><span class=o>.</span><span class=n>asnumpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>SaveImage</span><span class=p>(</span><span class=n>npimg</span><span class=p>,</span> <span class=n>outfn</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>remove_noise</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>callback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cbdata</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>outfn</span>
</span></span><span class=line><span class=cl>                <span class=n>cbdata</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>npimg</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>callback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>callback</span><span class=p>(</span><span class=n>cbdata</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>final_fn</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>output_dir</span> <span class=o>+</span> <span class=s1>&#39;/final.jpg&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>SaveImage</span><span class=p>(</span><span class=n>new_img</span><span class=o>.</span><span class=n>asnumpy</span><span class=p>(),</span> <span class=n>final_fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>get_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>train_nstyle</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/deep-learning/>Deep Learning</a>
<a href=/blog/tags/machine-learning/>Machine Learning</a>
<a href=/blog/tags/computer-vision/>Computer Vision</a>
<a href=/blog/tags/image-style-transfer/>Image Style Transfer</a>
<a href=/blog/tags/%E5%B7%B2%E5%A4%8D%E7%8E%B0/>å·²å¤ç°</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under Apache License 2.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/blog/p/perceptual-losses-for-real-time-style-transfer-and-super-resolution/><div class=article-details><h2 class=article-title>Perceptual Losses for Real-Time Style Transfer and Super-Resolution</h2></div></a></article><article><a href=/blog/p/spatial-temporal-graph-convolutional-networks-for-skeleton-based-action-recognition/><div class=article-details><h2 class=article-title>Spatial Temporal Graph Convolutional Networks for Skeleton-Based Action Recognition</h2></div></a></article><article><a href=/blog/p/identity-mappings-in-deep-residual-networks/><div class=article-details><h2 class=article-title>Identity Mappings in Deep Residual Networks</h2></div></a></article><article><a href=/blog/p/layer-normalization/><div class=article-details><h2 class=article-title>Layer Normalization</h2></div></a></article><article><a href=/blog/p/deeper-insights-into-graph-convolutional-networks-for-semi-supervised-learning/><div class=article-details><h2 class=article-title>Deeper Insights into Graph Convolutional Networks for Semi-Supervised Learning</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 Davidhamçš„åšå®¢</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>